name: Auto I18N Weekly

env:
  TRANSLATION_API_KEY: ${{ secrets.TRANSLATE_API_KEY }}
  TRANSLATION_MODEL: ${{ vars.AUTO_I18N_MODEL || 'deepseek/deepseek-v3.1'}}
  TRANSLATION_BASE_URL: ${{ vars.AUTO_I18N_BASE_URL || 'https://api.ppinfra.com/openai'}}
  TRANSLATION_BASE_LOCALE: ${{ vars.AUTO_I18N_BASE_LOCALE || 'en-us'}}

on:
  schedule:
    # Runs at 00:00 UTC every Sunday.
    # This corresponds to 08:00 AM UTC+8 (Beijing time) every Sunday.
    - cron: "0 0 * * 0"
  workflow_dispatch:

jobs:
  auto-i18n:
    runs-on: ubuntu-latest
    name: Auto I18N
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸˆâ€â¬› Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setting Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ“‚ Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ðŸ“¦ Install dependencies
        run: |
          pnpm install

      - name: ðŸƒâ€â™€ï¸ Translate
        run: pnpm i18n:sync && pnpm i18n:translate

      - name: ðŸ” Format
        run: pnpm format

      - name: ðŸ” Check for changes
        id: git_status
        run: |
          # Check if there are any uncommitted changes
          git reset -- package.json pnpm-lock.yaml  # ä¸æäº¤ package.json å’Œ pnpm-lock.yaml çš„æ›´æ”¹
          git diff --exit-code --quiet || echo "::set-output name=has_changes::true"
          git status --porcelain

      - name: ðŸ“… Set current date for PR title
        id: set_date
        run: echo "CURRENT_DATE=$(date +'%b %d, %Y')" >> $GITHUB_ENV # e.g., "Jun 06, 2024"

      - name: ðŸš€ Create Pull Request if changes exist
        if: steps.git_status.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Use the built-in GITHUB_TOKEN for bot actions
          commit-message: "feat(bot): Weekly automated script run"
          title: "ðŸ¤– Weekly Auto I18N Sync: ${{ env.CURRENT_DATE }}"
          body: |
            This PR includes changes generated by the weekly auto i18n.
            Review the changes before merging.

            ---
            _Generated by the automated weekly workflow_
          branch: "auto-i18n-weekly-${{ github.run_id }}" # Unique branch name
          base: "main" # Or 'develop', set your base branch
          delete-branch: true # Delete the branch after merging or closing the PR

      - name: ðŸ“¢ Notify if no changes
        if: steps.git_status.outputs.has_changes != 'true'
        run: echo "Bot script ran, but no changes were detected. No PR created."
